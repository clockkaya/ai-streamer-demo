<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>AI ä¸»æ’­ç›´æ’­é—´</title>
    <style>
        body { font-family: sans-serif; padding: 20px; background-color: #f4f4f9; }
        #chat-box { width: 100%; height: 300px; border: 1px solid #ccc; background: white; padding: 10px; overflow-y: auto; margin-bottom: 10px; border-radius: 8px; line-height: 1.6;}
        .bot-msg { color: #e91e63; font-weight: bold; }
        .user-msg { color: #2196f3; }
        input { width: 70%; padding: 10px; border-radius: 4px; border: 1px solid #ccc;}
        button { padding: 10px 20px; background-color: #4CAF50; color: white; border: none; border-radius: 4px; cursor: pointer;}
    </style>
</head>
<body>
    <h2>ğŸ”´ AI è™šæ‹Ÿä¸»æ’­ç›´æ’­é—´ (WebSocket æµ‹è¯•)</h2>
    <div id="chat-box"></div>
    <input type="text" id="danmaku-input" placeholder="è¾“å…¥å¼¹å¹•å’Œä¸»æ’­äº’åŠ¨å§..." onkeypress="if(event.key === 'Enter') sendDanmaku()">
    <button onclick="sendDanmaku()">å‘é€å¼¹å¹•</button>

    <script>
        // è¿æ¥ FastAPI çš„ WebSocket æœåŠ¡
        const ws = new WebSocket("ws://localhost:8000/ws/chat");
        const chatBox = document.getElementById("chat-box");
        let currentBotSpan = null; // ç”¨äºè¿½è¸ªå½“å‰ä¸»æ’­æ­£åœ¨è¾“å‡ºçš„é‚£å¥è¯çš„ DOM èŠ‚ç‚¹

        ws.onmessage = function(event) {
            const msg = event.data;

            // âš ï¸ æ–°å¢ï¼šæ‹¦æˆªéŸ³é¢‘æ•°æ®å¹¶æ’­æ”¾
            if (msg.startsWith("[AUDIO:")) {
                // æå– Base64 å­—ç¬¦ä¸² (å»æ‰ "[AUDIO:" å’Œç»“å°¾çš„ "]")
                const base64Audio = msg.substring(7, msg.length - 1);
                // ä½¿ç”¨ HTML5 Audio API æ’­æ”¾ Base64 éŸ³é¢‘
                const audio = new Audio("data:audio/mp3;base64," + base64Audio);
                audio.play();
                return; // éŸ³é¢‘æ•°æ®ä¸éœ€è¦æ˜¾ç¤ºåœ¨èŠå¤©æ¡†é‡Œ
            }

            if (msg === "[EOF]") {
                currentBotSpan = null;
                chatBox.innerHTML += "<hr/>";
            } else {
                if (!currentBotSpan) {
                    chatBox.innerHTML += `<span class="bot-msg">ğŸŒŸ æ˜Ÿç³: </span>`;
                    currentBotSpan = document.createElement("span");
                    chatBox.appendChild(currentBotSpan);
                }
                currentBotSpan.innerHTML += msg;
            }
            chatBox.scrollTop = chatBox.scrollHeight;
        };

        function sendDanmaku() {
            const input = document.getElementById("danmaku-input");
            const text = input.value;
            if (text) {
                chatBox.innerHTML += `<div class="user-msg">ğŸ’¬ ä½ : ${text}</div>`;
                ws.send(text); // é€šè¿‡ WebSocket å‘é€ç»™åç«¯
                input.value = "";
                chatBox.scrollTop = chatBox.scrollHeight;
            }
        }
    </script>
</body>
</html>