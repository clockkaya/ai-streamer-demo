<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <title>AI ä¸»æ’­ç›´æ’­é—´</title>
    <style>
        body {
            font-family: sans-serif;
            padding: 20px;
            background-color: #f4f4f9;
        }

        #chat-box {
            width: 100%;
            height: 400px;
            border: 1px solid #ccc;
            background: white;
            padding: 10px;
            overflow-y: auto;
            margin-bottom: 10px;
            border-radius: 8px;
            line-height: 1.6;
        }

        .bot-msg {
            color: #e91e63;
            font-weight: bold;
        }

        .user-msg {
            color: #2196f3;
        }

        .other-user-msg {
            color: #9c27b0;
        }

        .system-msg {
            color: #999;
            font-style: italic;
            font-size: 0.9em;
        }

        input {
            padding: 10px;
            border-radius: 4px;
            border: 1px solid #ccc;
        }

        #danmaku-input {
            width: 60%;
        }

        #room-input {
            width: 15%;
            margin-right: 5px;
        }

        button {
            padding: 10px 20px;
            background-color: #4CAF50;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }

        #connect-btn {
            background-color: #2196f3;
        }

        #status {
            margin-top: 10px;
            color: #666;
        }

        .controls {
            margin-bottom: 15px;
        }
    </style>
</head>

<body>
    <h2>ğŸ”´ AI è™šæ‹Ÿä¸»æ’­ç›´æ’­é—´ (WebSocket æµ‹è¯•)</h2>

    <div class="controls">
        <input type="text" id="room-input" value="star" placeholder="æˆ¿é—´ ID">
        <button id="connect-btn" onclick="connectRoom()">åŠ å…¥æˆ¿é—´</button>
        <span id="status">æœªè¿æ¥</span>
    </div>

    <div id="chat-box"></div>
    <input type="text" id="danmaku-input" placeholder="è¾“å…¥å¼¹å¹•å’Œä¸»æ’­äº’åŠ¨å§..."
        onkeypress="if(event.key === 'Enter') sendDanmaku()" disabled>
    <button onclick="sendDanmaku()" id="send-btn" disabled>å‘é€å¼¹å¹•</button>

    <script>
        let ws = null;
        const chatBox = document.getElementById("chat-box");
        const statusEl = document.getElementById("status");
        const danmakuInput = document.getElementById("danmaku-input");
        const sendBtn = document.getElementById("send-btn");
        let currentBotSpan = null;
        let lastSentMessage = null;

        function connectRoom() {
            const roomId = document.getElementById("room-input").value.trim();
            if (!roomId) { alert("è¯·è¾“å…¥æˆ¿é—´ ID"); return; }

            // æ–­å¼€æ—§è¿æ¥
            if (ws) { ws.close(); }

            chatBox.innerHTML = "";
            chatBox.innerHTML += `<div class="system-msg">æ­£åœ¨åŠ å…¥æˆ¿é—´ [${roomId}]...</div>`;

            ws = new WebSocket(`ws://localhost:8000/ws/rooms/${roomId}`);

            ws.onopen = function () {
                statusEl.textContent = `âœ… å·²è¿æ¥æˆ¿é—´ [${roomId}]`;
                statusEl.style.color = "#4CAF50";
                danmakuInput.disabled = false;
                sendBtn.disabled = false;
                chatBox.innerHTML += `<div class="system-msg">å·²åŠ å…¥æˆ¿é—´ [${roomId}] ğŸ‰</div>`;
            };

            ws.onclose = function () {
                statusEl.textContent = "âŒ è¿æ¥å·²æ–­å¼€";
                statusEl.style.color = "#f44336";
                danmakuInput.disabled = true;
                sendBtn.disabled = true;
            };

            ws.onmessage = function (event) {
                const msg = event.data;

                // å¤„ç†å¹¿æ’­çš„è§‚ä¼—å¼¹å¹•
                if (msg.startsWith("[USER:") && msg.endsWith("]")) {
                    const userMsg = msg.substring(6, msg.length - 1);
                    if (userMsg === lastSentMessage) {
                        lastSentMessage = null;
                    } else {
                        chatBox.innerHTML += `<div class="other-user-msg">ğŸ’¬ è§‚ä¼—: ${userMsg}</div>`;
                        chatBox.scrollTop = chatBox.scrollHeight;
                    }
                    return;
                }

                // å¤„ç†éŸ³é¢‘æ•°æ®
                if (msg.startsWith("[AUDIO:")) {
                    const base64Audio = msg.substring(7, msg.length - 1);
                    const audio = new Audio("data:audio/mp3;base64," + base64Audio);
                    audio.play();
                    return;
                }

                // å¤„ç†ç»“æŸæ ‡è®°
                if (msg === "[EOF]") {
                    currentBotSpan = null;
                    chatBox.innerHTML += "<hr/>";
                    chatBox.scrollTop = chatBox.scrollHeight;
                    return;
                }

                // å¤„ç†ä¸»æ’­æµå¼å›å¤
                if (!currentBotSpan) {
                    chatBox.innerHTML += `<span class="bot-msg">ğŸŒŸ æ˜Ÿç³: </span>`;
                    currentBotSpan = document.createElement("span");
                    chatBox.appendChild(currentBotSpan);
                }
                currentBotSpan.innerHTML += msg;
                chatBox.scrollTop = chatBox.scrollHeight;
            };
        }

        function sendDanmaku() {
            if (!ws || ws.readyState !== WebSocket.OPEN) { return; }
            const text = danmakuInput.value;
            if (text) {
                chatBox.innerHTML += `<div class="user-msg">ğŸ’¬ ä½ : ${text}</div>`;
                lastSentMessage = text;
                ws.send(text);
                danmakuInput.value = "";
                chatBox.scrollTop = chatBox.scrollHeight;
            }
        }
    </script>
</body>

</html>