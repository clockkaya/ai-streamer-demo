<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>AI ä¸»æ’­ç›´æ’­é—´</title>
    <style>
        body { font-family: sans-serif; padding: 20px; background-color: #f4f4f9; }
        #chat-box { width: 100%; height: 400px; border: 1px solid #ccc; background: white; padding: 10px; overflow-y: auto; margin-bottom: 10px; border-radius: 8px; line-height: 1.6;}
        .bot-msg { color: #e91e63; font-weight: bold; }
        .user-msg { color: #2196f3; }
        .other-user-msg { color: #9c27b0; }
        .system-msg { color: #999; font-style: italic; font-size: 0.9em; }
        input { width: 70%; padding: 10px; border-radius: 4px; border: 1px solid #ccc;}
        button { padding: 10px 20px; background-color: #4CAF50; color: white; border: none; border-radius: 4px; cursor: pointer;}
        #status { margin-top: 10px; color: #666; }
    </style>
</head>
<body>
    <h2>ğŸ”´ AI è™šæ‹Ÿä¸»æ’­ç›´æ’­é—´ (WebSocket æµ‹è¯•)</h2>
    <div id="chat-box"></div>
    <input type="text" id="danmaku-input" placeholder="è¾“å…¥å¼¹å¹•å’Œä¸»æ’­äº’åŠ¨å§..." onkeypress="if(event.key === 'Enter') sendDanmaku()">
    <button onclick="sendDanmaku()">å‘é€å¼¹å¹•</button>
    <div id="status">è¿æ¥ä¸­...</div>

    <script>
        const ws = new WebSocket("ws://localhost:8000/ws/chat");
        const chatBox = document.getElementById("chat-box");
        const statusEl = document.getElementById("status");
        let currentBotSpan = null;  // è¿½è¸ªä¸»æ’­å½“å‰æ­£åœ¨è¾“å‡ºçš„ DOM èŠ‚ç‚¹
        let lastSentMessage = null; // è®°å½•è‡ªå·±åˆšå‘çš„æ¶ˆæ¯ï¼Œç”¨äºåŒºåˆ†"è‡ªå·±"å’Œ"å…¶ä»–è§‚ä¼—"

        ws.onopen = function() {
            statusEl.textContent = "âœ… å·²è¿æ¥ç›´æ’­é—´";
            statusEl.style.color = "#4CAF50";
        };

        ws.onclose = function() {
            statusEl.textContent = "âŒ è¿æ¥å·²æ–­å¼€";
            statusEl.style.color = "#f44336";
        };

        ws.onmessage = function(event) {
            const msg = event.data;

            // å¤„ç†å¹¿æ’­çš„è§‚ä¼—å¼¹å¹• [USER:æ¶ˆæ¯å†…å®¹]
            if (msg.startsWith("[USER:") && msg.endsWith("]")) {
                const userMsg = msg.substring(6, msg.length - 1);
                // åˆ¤æ–­æ˜¯è‡ªå·±å‘çš„è¿˜æ˜¯å…¶ä»–è§‚ä¼—å‘çš„
                if (userMsg === lastSentMessage) {
                    // è‡ªå·±çš„å¼¹å¹•ï¼ˆå·²ç»åœ¨ sendDanmaku ä¸­æ˜¾ç¤ºè¿‡äº†ï¼Œè·³è¿‡ï¼‰
                    lastSentMessage = null;
                } else {
                    // å…¶ä»–è§‚ä¼—çš„å¼¹å¹•
                    chatBox.innerHTML += `<div class="other-user-msg">ğŸ’¬ è§‚ä¼—: ${userMsg}</div>`;
                    chatBox.scrollTop = chatBox.scrollHeight;
                }
                return;
            }

            // å¤„ç†éŸ³é¢‘æ•°æ®
            if (msg.startsWith("[AUDIO:")) {
                const base64Audio = msg.substring(7, msg.length - 1);
                const audio = new Audio("data:audio/mp3;base64," + base64Audio);
                audio.play();
                return;
            }

            // å¤„ç†ç»“æŸæ ‡è®°
            if (msg === "[EOF]") {
                currentBotSpan = null;
                chatBox.innerHTML += "<hr/>";
                chatBox.scrollTop = chatBox.scrollHeight;
                return;
            }

            // å¤„ç†ä¸»æ’­æµå¼å›å¤
            if (!currentBotSpan) {
                chatBox.innerHTML += `<span class="bot-msg">ğŸŒŸ æ˜Ÿç³: </span>`;
                currentBotSpan = document.createElement("span");
                chatBox.appendChild(currentBotSpan);
            }
            currentBotSpan.innerHTML += msg;
            chatBox.scrollTop = chatBox.scrollHeight;
        };

        function sendDanmaku() {
            const input = document.getElementById("danmaku-input");
            const text = input.value;
            if (text) {
                // å…ˆåœ¨æœ¬åœ°æ˜¾ç¤ºè‡ªå·±çš„å¼¹å¹•
                chatBox.innerHTML += `<div class="user-msg">ğŸ’¬ ä½ : ${text}</div>`;
                lastSentMessage = text;  // è®°å½•ï¼Œé¿å…å¹¿æ’­æ—¶é‡å¤æ˜¾ç¤º
                ws.send(text);
                input.value = "";
                chatBox.scrollTop = chatBox.scrollHeight;
            }
        }
    </script>
</body>
</html>